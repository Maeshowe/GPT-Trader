name: GPT Portfolio Pipeline

on:
  push:
    branches: [ main ]          # â† cserÃ©ld, ha nem "main"
  workflow_dispatch:            # kÃ©zi indÃ­tÃ¡s

permissions:
  contents: write               # kell a CI-commit-hoz

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
    # â”€â”€ 1) Repo checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Checkout repo
      uses: actions/checkout@v4

    # â”€â”€ 2) Python env â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # â”€â”€ 3) Dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install aiohttp scipy  # Enhanced dependencies for risk management

    # â”€â”€ 4) Create logs directory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Create logs directory
      run: |
        mkdir -p logs
        mkdir -p outputs

    # â”€â”€ 5) Secrets â†’ ENV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Export secrets
      run: |
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}"      >> $GITHUB_ENV
        echo "FRED_API_KEY=${{ secrets.FRED_API_KEY }}"          >> $GITHUB_ENV
        echo "STOCKNEWS_API_KEY=${{ secrets.STOCKNEWS_API_KEY }}" >> $GITHUB_ENV

    # â”€â”€ 6) Enhanced pipeline execution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Run enhanced GPT portfolio pipeline
      run: |
        echo "ğŸš€ Starting Enhanced GPT Portfolio Pipeline..."
        
        # Step 1: Data fetching
        echo "ğŸ“Š Step 1: Fetching market data..."
        python data_fetch/fetch_data.py
        
        # Step 2: LLM scoring (enhanced with async & logging)
        echo "ğŸ¤– Step 2: Running LLM scoring with enhanced performance..."
        python run_prompts.py
        
        # Step 3: News sentiment analysis (enhanced with retry logic)
        echo "ğŸ“° Step 3: Analyzing news sentiment with intelligent retry..."
        python news_sentiment.py
        
        # Step 4: Portfolio generation
        echo "âš–ï¸ Step 4: Generating base portfolio..."
        python generator_runner.py
        
        # Step 5: Risk management integration (NEW!)
        echo "ğŸ›¡ï¸ Step 5: Applying risk management framework..."
        python integrate_risk_management.py
        
        # Step 6: Backtesting
        echo "ğŸ“ˆ Step 6: Running backtest analysis..."
        python backtest.py
        python backtest_rebal.py
        
        # Step 7: Risk budget optimization
        echo "ğŸ’° Step 7: Calculating risk budget allocations..."
        python risk_budget.py
        
        echo "âœ… Pipeline completed successfully!"

    # â”€â”€ 7) Validate outputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Validate pipeline outputs
      run: |
        echo "ğŸ” Validating pipeline outputs..."
        
        # Check critical files exist
        required_files=(
          "outputs/portfolio_latest.json"
          "outputs/portfolio_risk_adjusted.json"
          "outputs/portfolio_risk_assessment.json"
          "outputs/risk_summary.md"
          "outputs/news_sentiment.json"
          "outputs/backtest_equity.json"
          "outputs/backtest_stats.json"
        )
        
        missing_files=()
        for file in "${required_files[@]}"; do
          if [[ ! -f "$file" ]]; then
            missing_files+=("$file")
          else
            echo "âœ… $file exists"
          fi
        done
        
        if [[ ${#missing_files[@]} -gt 0 ]]; then
          echo "âŒ Missing critical files:"
          printf '%s\n' "${missing_files[@]}"
          exit 1
        fi
        
        # Validate JSON files
        echo "ğŸ” Validating JSON files..."
        for json_file in outputs/*.json; do
          if [[ -f "$json_file" ]]; then
            if python -m json.tool "$json_file" > /dev/null 2>&1; then
              echo "âœ… $json_file is valid JSON"
            else
              echo "âŒ $json_file is invalid JSON"
              exit 1
            fi
          fi
        done
        
        echo "âœ… All validations passed!"

    # â”€â”€ 8) Generate pipeline summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Generate pipeline summary
      run: |
        echo "ğŸ“Š Generating pipeline execution summary..."
        
        # Create summary file
        cat > pipeline_summary.md << EOF
        # GPT Portfolio Pipeline Execution Summary
        
        **Execution Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
        **Commit:** ${{ github.sha }}
        **Triggered by:** ${{ github.event_name }}
        
        ## Pipeline Steps Completed
        - âœ… Data fetching (FRED, StockNews, Yahoo Finance)
        - âœ… Enhanced LLM scoring (Async with ${MAX_CONCURRENCY:-8}x concurrency)
        - âœ… News sentiment analysis (With intelligent retry logic)
        - âœ… Portfolio generation (LLM-based allocation)
        - âœ… **Risk management integration** (Governance + Market risk)
        - âœ… Backtesting (Buy&Hold vs Rebalancing)
        - âœ… Risk budget optimization (Black-Litterman)
        
        ## Key Outputs Generated
        $(ls -la outputs/ | grep -v '^d' | awk '{print "- " $9 " (" $5 " bytes)"}')
        
        ## Risk Assessment Summary
        $(if [ -f "outputs/risk_summary.md" ]; then head -20 outputs/risk_summary.md; else echo "Risk summary not available"; fi)
        
        ## Performance Logs
        $(if [ -f "logs/gpt_trader.log" ]; then echo "Enhanced logging active - $(wc -l < logs/gpt_trader.log) log entries"; else echo "No performance logs"; fi)
        
        EOF
        
        echo "ğŸ“„ Pipeline summary generated"

    # â”€â”€ 9) Enhanced commit & push output files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Commit enhanced outputs
      run: |
        set -e
        git config --global user.email "actions@github.com"
        git config --global user.name  "github-actions[bot]"

        # Force-add all output files (ignore .gitignore rules)
        git add -f \
          outputs/portfolio_latest.json \
          outputs/portfolio_risk_adjusted.json \
          outputs/portfolio_risk_assessment.json \
          outputs/risk_assessment_report.json \
          outputs/risk_summary.md \
          outputs/news_sentiment.json \
          outputs/news_sentiment_detailed.json \
          outputs/portfolio_risk_budget.json \
          outputs/backtest_equity.json \
          outputs/backtest_rebal_equity.json \
          outputs/backtest_rebal_stats.json \
          outputs/backtest_stats.json \
          pipeline_summary.md
        
        # Add performance logs if they exist
        if ls logs/performance_*.json 1> /dev/null 2>&1; then
          git add -f logs/performance_*.json
        fi
        
        # Add main log file if it exists (but limit size)
        if [[ -f "logs/gpt_trader.log" ]]; then
          # Only add if log file is reasonable size (< 1MB)
          if [[ $(stat -f%z "logs/gpt_trader.log" 2>/dev/null || stat -c%s "logs/gpt_trader.log" 2>/dev/null || echo 0) -lt 1048576 ]]; then
            git add -f logs/gpt_trader.log
          else
            echo "âš ï¸ Log file too large, skipping commit"
          fi
        fi

        # Commit only if there are actual changes
        if ! git diff --cached --quiet; then
          # Enhanced commit message with summary
          commit_msg="[CI] Enhanced pipeline autoupdate $(date -u +'%Y-%m-%dT%H:%MZ')

          ğŸš€ Enhanced GPT Portfolio Pipeline Results:
          - âœ… Risk Management Integration Active
          - âœ… Enhanced LLM Scoring with Async Processing  
          - âœ… Intelligent News Sentiment Analysis
          - âœ… Risk-Adjusted Portfolio Generation
          - âœ… Comprehensive Risk Assessment Reports
          
          ğŸ“Š Key Files Updated:
          $(git diff --cached --name-only | head -10)
          $([ $(git diff --cached --name-only | wc -l) -gt 10 ] && echo "... and $(expr $(git diff --cached --name-only | wc -l) - 10) more files")
          
          ğŸ›¡ï¸ Risk Level: $(grep "Overall Risk Level:" outputs/risk_summary.md 2>/dev/null | head -1 | cut -d: -f2 | xargs || echo "Unknown")
          ğŸ“ˆ Compliance: $(grep "Compliance Status:" outputs/risk_summary.md 2>/dev/null | head -1 | cut -d: -f2 | xargs || echo "Unknown")"
          
          git commit -m "$commit_msg"
          git push
          
          echo "âœ… Enhanced outputs committed and pushed successfully!"
        else
          echo "â„¹ï¸ No changes to commit - pipeline outputs unchanged"
        fi

    # â”€â”€ 10) Workflow summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Workflow completion summary
      if: always()
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ‰ ENHANCED GPT PORTFOLIO PIPELINE COMPLETED"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“… Execution Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â±ï¸  Total Duration: $SECONDS seconds"
        echo "ğŸ”§ Enhanced Features:"
        echo "   â€¢ 8x Async LLM Processing"
        echo "   â€¢ Intelligent Retry Logic"
        echo "   â€¢ Risk Management Integration"
        echo "   â€¢ Governance Risk Assessment"
        echo "   â€¢ Automated Risk Adjustments"
        echo "   â€¢ Comprehensive Logging"
        echo ""
        echo "ğŸ“Š Output Files Generated:"
        ls -la outputs/ 2>/dev/null | grep -v '^d' | wc -l | xargs echo "   â€¢" "files in outputs/"
        echo ""
        echo "ğŸ›¡ï¸ Risk Assessment:"
        if [[ -f "outputs/risk_summary.md" ]]; then
          grep -E "(Overall Risk Level|Compliance Status)" outputs/risk_summary.md | sed 's/^/   â€¢ /'
        else
          echo "   â€¢ Risk assessment data not available"
        fi
        echo ""
        echo "ğŸš€ Ready for dashboard viewing at:"
        echo "   ğŸ“Š https://gpt-trader-yprfiqjxyzfscnqejjq93n.streamlit.app"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Thank you for using the Enhanced GPT Portfolio Pipeline!"
        echo "For issues, please open a ticket at: https://github.com/Maeshowe/issues"