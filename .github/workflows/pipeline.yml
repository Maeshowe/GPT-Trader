name: GPT Portfolio Pipeline

on:
  push:
    branches: [ main ]          # â† cserÃ©ld, ha nem "main"
  workflow_dispatch:            # kÃ©zi indÃ­tÃ¡s

permissions:
  contents: write               # kell a CI-commit-hoz

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
    # â”€â”€ 1) Repo checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Checkout repo
      uses: actions/checkout@v4

    # â”€â”€ 2) Python env â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # â”€â”€ 3) System deps (TAâ€‘Lib headers) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    #    Fixes wheelâ€‘build error: "fatal error: ta-lib/ta_defs.h: No such file or directory"
    - name: Install TAâ€‘Lib system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libta-lib0 libta-lib0-dev

    # â”€â”€ 4) Python dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        #  ta-lib will now compile successfully because the headers are present
        pip install -r requirements.txt
        pip install aiohttp scipy  # extra deps

    # â”€â”€ 5) Create logs & outputs dirs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Create logs and outputs directories
      run: |
        mkdir -p logs
        mkdir -p outputs

    # â”€â”€ 6) Secrets â†’ ENV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Export secrets
      run: |
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}"      >> $GITHUB_ENV
        echo "FRED_API_KEY=${{ secrets.FRED_API_KEY }}"          >> $GITHUB_ENV
        echo "STOCKNEWS_API_KEY=${{ secrets.STOCKNEWS_API_KEY }}" >> $GITHUB_ENV

    # â”€â”€ 7) Run pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Run GPT portfolio pipeline
      run: |
        echo "ğŸš€ Starting GPT Portfolio Pipeline..."
        echo "ğŸ“Š Step 1: Fetching market data..." && python data_fetch/fetch_data.py
        echo "ğŸ¤– Step 2: Running LLM scoring..."    && python run_prompts.py
        echo "ğŸ“° Step 3: Analyzing news sentiment..." && python news_sentiment.py
        echo "âš–ï¸ Step 4: Generating portfolio..."  && python generator_runner.py
        echo "ğŸ›¡ï¸ Step 5: Applying risk management..." && python integrate_risk_management.py
        echo "ğŸ“ˆ Step 6: Backtesting..."           && python backtest.py && python backtest_rebal.py
        echo "ğŸ’° Step 7: Risk budget optimization..." && python risk_budget.py
        echo "âœ… Pipeline completed successfully!"

    # â”€â”€ 8) Validate outputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Validate pipeline outputs
      run: |
        echo "ğŸ” Validating pipeline outputs..."
        required_files=(
          "outputs/portfolio_latest.json"
          "outputs/portfolio_risk_adjusted.json"
          "outputs/portfolio_risk_assessment.json"
          "outputs/risk_summary.md"
          "outputs/news_sentiment.json"
          "outputs/backtest_equity.json"
          "outputs/backtest_stats.json"
        )
        missing=()
        for f in "${required_files[@]}"; do
          [[ -f "$f" ]] && echo "âœ… $f exists" || missing+=("$f")
        done
        if (( ${#missing[@]} )); then
          echo "âŒ Missing files:"; printf '%s\n' "${missing[@]}"; exit 1; fi
        echo "ğŸ” Validating JSON..."
        for jf in outputs/*.json; do python -m json.tool "$jf" > /dev/null || { echo "âŒ $jf invalid"; exit 1; }; done
        echo "âœ… All validations passed!"

    # â”€â”€ 9) Generate summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Generate pipeline summary
      run: |
        echo "ğŸ“Š Generating summary..."
        cat > pipeline_summary.md <<EOF
        # GPT Portfolio Pipeline Execution Summary
        **Execution Date:** \$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        **Commit:** \${{ github.sha }}
        **Triggered by:** \${{ github.event_name }}
        EOF

    # â”€â”€ 10) Commit outputs (unchanged block) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Commit pipeline outputs
      run: |
        set -e
        git config --global user.email "actions@github.com"
        git config --global user.name  "github-actions[bot]"
        # (commit logic unchanged, omitted here for brevity)
        echo "â„¹ï¸ Commit step trimmed in this snippet"

    # â”€â”€ 11) Final workflow summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Workflow completion summary
      if: always()
      run: |
        echo "ğŸ‰ GPT PORTFOLIO PIPELINE COMPLETED â€” see summary above"
